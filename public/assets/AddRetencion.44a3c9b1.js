import{Q as be,a as U}from"./QBreadcrumbs.e4aa0249.js";import{Q as he}from"./QSpinnerFacebook.1cd49dd2.js";import{r as h,v as xe,x as we,o as m,c as M,e as l,ae as i,f as o,g as s,aU as H,ad as n,bb as P,ba as ye,aj as qe,by as Ae,P as Q,aV as W,aa as _,ab as p,a9 as g,bA as Ie,i as S,w as Re,af as L,Q as O,bz as Oe,h as X,bj as Ce,O as D}from"./index.29f4c737.js";import{a as y,Q as q,d as $}from"./format.32e8bea4.js";import{Q as B}from"./QSelect.af5c5eb7.js";import{Q as C}from"./QTd.23ff1cd7.js";import{Q as Ve}from"./QTable.1092949f.js";import{Q as Se}from"./QBadge.4e28918c.js";import{Q as ee}from"./QList.735afe1b.js";import{Q as ae}from"./QBtnDropdown.1c68582b.js";import{Q as De}from"./QForm.ffe755a4.js";import{C as N}from"./ClosePopup.7003054d.js";import{u as $e}from"./useHelpers.c99bee56.js";import{d as Ne}from"./date.39b202c1.js";import{u as Te,_ as Ee}from"./SelectProduct.dbf80fde.js";import"./QBtnGroup.ca9c9ecb.js";import"./use-quasar.a55b1bc0.js";import"./axios.dda82ddd.js";import"./QInnerLoading.1dedf0d2.js";const ke={class:"q-ma-lg q-pt-md q-mb-none",style:{"margin-bottom":"10px"}},Fe={class:"row q-col-gutter-lg flex items-center"},Ue=l("label",{class:"text-h6 text-center"},"Nueva Factura/Proforma",-1),Me=[Ue],Pe={class:"row q-mx-lg q-col-gutter-md"},Qe={class:"text-weight-regular"},Le=l("span",{class:"q-mr-sm"},"N\xB0 Factura:",-1),Be={key:1,class:"text-weight-regular"},je={class:"col-xs-12 col-sm-12 col-md-6 q-mt-md q-pl-none"},ze=l("label",null,"Seleccionar Cliente: ",-1),Ge=l("label",null,"Seleccionar Sucursal: ",-1),Ye={class:"row q-pt-lg q-mx-lg q-col-gutter-md"},Je={class:"col-xs-12 col-md-6 q-pl-none"},Ke=l("label",null,"Filtrar por codigo de barra o nombre del producto:",-1),Ze=l("label",null,"Forma de pago:",-1),He={class:"q-mx-lg justify-center q-mt-md"},We={class:"col-12"},Xe={class:"full-width row flex-center text-lime-10 q-gutter-sm"},ea=l("span",{class:"text-subtitle1"}," Agrega alg\xFAn Producto ",-1),aa={class:"row",style:{width:"100%"}},la=l("label",{class:"q-pr-md"}," Descripci\xF3n (Opcional) ",-1),ta=[la],sa={class:"col-xs-12 col-sm-7 col-md-9"},oa={class:"q-ml-sm q-mt-md"},ra={class:"col-xs-12 col-sm-4 col-md-5",style:{display:"flex","justify-content":"end"}},na={class:"text-right"},ia=l("td",null,[l("b",null,"TOTAL BRUTO:")],-1),da={style:{width:"50px"},class:"text-subtitle1 text-weight-regular"},ua={class:"text-right"},ca=l("td",null,[l("b",null,"DESCUENTOS:")],-1),ma={style:{width:"50px"},class:"text-subtitle1 text-weight-regular"},pa={class:"text-right"},va=l("td",null,[l("b",null,"SUBTOTAL:")],-1),fa={style:{width:"50px"},class:"text-subtitle1 text-weight-regular"},_a={class:"text-right"},ga={style:{width:"50px"},class:"text-subtitle1 text-weight-regular"},ba={class:"text-right"},ha=l("td",null,[l("b",null,"TOTAL DE VENTA:")],-1),xa={style:{width:"50px"}},Qa={__name:"AddRetencion",setup(wa){const{filterByCodBarra:A,columns:j,rows:x,modalSelectProducto:V,loadingState:le,listProductos:te,valorFactura:f,agregarAndValidarStock:z,filterArticulo:se,formatearNumero:oe,getSubtotalByProduct:T,sucursal_selected:v,iva_selected:G,quitarArticulo:re}=Te();let Y=[];const b=h([]),{api:I,claim:c,mostrarNotify:w,route:J,router:ne}=$e(),E=h([]),ie=h(!1),k=h(!1),F=h(!0),K=h(""),de=Date.now();let ue=Ne.formatDate(de,"DD/MM/YYYY");(c.roles[0]!=="SUPER-ADMINISTRADOR"||c.roles[0]!=="ADMINISTRADOR")&&(v.value=c.sucursales[0]),j.value[7]={name:"pvp",label:"Precio de Venta",align:"center"};const r=h({customer_id:"5e909ecb-81f5-4cab-a663-ce3786c0db49",numero_comprobante:"--- --- ---------",products:[],user_id:"",forma_pago:"",descripcion:""}),u=h({customer_id:{message:"",isValid:!0},sucursal_id:{message:"",isValid:!0},forma_pago:{message:"",isValid:!0}});xe(v,(t,e)=>{Z()});const ce=async t=>{E.value=[];const{data:e}=await I.get(`/sucursal/find/${t}/company`);e.forEach(a=>{E.value.push({label:a.nombre,value:a.id})})},me=async()=>{if(J.params.venta_id!==""){const{data:t}=await I.get(`/invoices/filterInvoice/${J.params.venta_id}`);r.value.customer_id=t.customer_id.id,r.value.id=t.id,r.value.clave_acceso=t.clave_acceso,r.value.estadoSRI=t.estadoSRI,r.value.forma_pago=t.forma_pago,r.value.descripcion=t.descripcion,v.value=t.sucursal_id.id,K.value=t.name_proforma,t.invoiceToProduct.forEach(e=>{e.product_id.cantidad=e.cantidad,e.product_id.descuento=parseFloat(e.descuento),e.product_id.v_total=e.v_total,e.product_id.pvp=parseFloat(e.v_total)/parseInt(e.cantidad),z(e.product_id,"proforma")})}},pe=t=>{z(t,"venta"),V.value=!1},ve=async()=>{const t=r.value.customer_id;r.value.customer_id="",ie.value=!1;try{let e={"company-id":c.company.id};const{data:a}=await I.get("/customers",{headers:e});b.value=[],a.forEach(d=>{b.value.push({label:d.nombres,value:d.id,num_doc:d.numero_documento})}),b.value.unshift({label:"CONSUMIDOR FINAL",value:"5e909ecb-81f5-4cab-a663-ce3786c0db49",num_doc:"9999999999999"}),Y=b.value,r.value.customer_id=t,me()}catch(e){console.log(e)}},fe=(t="",e)=>{if(t==="")return e(()=>{b.value=Y});e(()=>{const a=t.toLowerCase();b.value=b.value.filter(d=>d.num_doc.indexOf(a)>-1||d.label.toLowerCase().indexOf(a)>-1)})},_e=t=>{let e=!1;return(c.roles[0]=="SUPER-ADMINISTRADOR"||c.roles[0]=="ADMINISTRADOR")&&v.value==""&&(u.value.sucursal_id.message="Debes seleccionar una sucursal",u.value.sucursal_id.isValid=!1,e=!0),f.value.total>50&&r.value.customer_id=="5e909ecb-81f5-4cab-a663-ce3786c0db49"&&t!="PROFORMA"&&(u.value.customer_id.message="La factura supera los $50.00, no puede ser emitida a CONSUMIDOR FINAL",u.value.customer_id.isValid=!1,e=!0),f.value.total>50&&r.value.forma_pago=="01"&&(u.value.forma_pago.message="La factura supera los $500.00, debes elegir otra forma de pago",u.value.forma_pago.isValid=!1,e=!0),x.value.length==0&&(e=!0,w("warning","Debes agregar algun producto..")),r.value.forma_pago.length==0&&(u.value.forma_pago.message="Debes elegir una forma de pago",u.value.forma_pago.isValid=!1,e=!0),x.value.forEach((a,d)=>{a.cantidad<=0&&(e=!0,w("warning",`Agrega una cantidad cantidad al producto: ${a.nombre} de la fila: ${d+1}`)),a.cantidad>a.stock&&a.tipo!="Servicio"&&(e=!0,w("warning",`La cantidad de venta del producto: ${a.nombre} supera su stock disponible`))}),e},R=async t=>{if(_e(t))return;r.value={...r.value,...f.value,products:x.value,user_id:c.id,tipo:t,send_messages:F,porcentaje_iva:G.value,name_proforma:K.value};let e;t=="EMISION"&&(e="\xBFDeseas emitir factura de esta proforma?"),t=="FACTURA"&&(e="\xBFDeseas generar esta FACTURA?"),t=="PROFORMA"&&(e="\xBFDeseas guardar como PROFORMA?"),Ae.create({title:e,ok:{push:!0,color:"cyan-10",label:"Enviar"},cancel:{push:!0,color:"blue-grey-6",label:"Cancelar"}}).onOk(async()=>{try{Q.show({message:"Cargando..."});let a={headers:{"sucursal-id":v.value}};await I.post("/invoices",r.value,a),Q.hide(),w("positive","Venta realizada exitosamente"),ne.push("/ventas")}catch(a){w("warning",a.response.data.message),Q.hide()}})},ge=()=>{if((c.roles[0]=="SUPER-ADMINISTRADOR"||c.roles[0]=="ADMINISTRADOR")&&typeof v.value=="undefined")return w("warning","Elige una sucursal primeramente");se("venta")},Z=async()=>{k.value=!0;let t={headers:{"sucursal-id":v.value}};const{data:e}=await I.get("/CE/facturas/getNumFactura",t);r.value.numero_comprobante=e.numComprobante,k.value=!1};return we(()=>{x.value=[]}),c.roles[0]=="SUPER-ADMINISTRADOR"||c.roles[0]=="ADMINISTRADOR"?ce(c.company.id):Z(),ve(),(t,e)=>(m(),M(qe,null,[l("div",ke,[l("div",Fe,[l("div",{class:i(["col-xs-12 col-md-6",[(t.$q.screen.width<1022,"q-pt-sm")]])},[o(be,{class:i(["row q-mr-xs",[t.$q.screen.width<1022?"justify-center q-pt-sm":"justify-start "]])},{default:s(()=>[o(U,{label:"Inicio",icon:"home",to:"/"}),o(U,{label:"Facturas",icon:"payments",to:"/ventas"}),o(U,{label:"Factura/Prof.",icon:"add_circle"})]),_:1},8,["class"])],2),l("div",{class:i(["col-xs-12 col-md-6",[t.$q.screen.width<1022?"text-center q-pt-sm":"text-right q-pt-sm"]])},Me,2)])]),o(H,{class:"q-mx-lg q-mt-lg"},{default:s(()=>[o(W,{class:"q-pt-none"},{default:s(()=>[l("div",Pe,[l("div",{class:i(["col-xs-12 col-md-6 q-pt-xs q-mt-md",t.$q.screen.width>=1023||"text-center"])},[l("label",{class:i(["text-weight-medium",[t.$q.screen.xs?"text-subtitle1":"text-h5"]])},[_("Fecha de Emisi\xF3n: "),l("span",Qe,p(n(ue)),1)],2)],2),l("div",{class:i(["col-xs-12 col-md-6",t.$q.screen.width<=1023?"text-center q-pt-sm":"text-right q-pt-xs q-mt-md"])},[l("label",{class:i(["q-mr-lg text-weight-medium",[t.$q.screen.xs?"text-subtitle1":"text-h5"]])},[Le,k.value?(m(),g(he,{key:0,color:"primary",class:"q-ml-md",size:"2em"})):(m(),M("span",Be,p(r.value.numero_comprobante),1))],2)],2),l("div",je,[ze,o(B,{color:"orange",filled:"",modelValue:r.value.customer_id,"onUpdate:modelValue":[e[1]||(e[1]=a=>r.value.customer_id=a),e[2]||(e[2]=a=>u.value.customer_id.isValid=!0)],options:b.value,"emit-value":"","map-options":"",dense:"",error:!u.value.customer_id.isValid,onFilter:fe,"use-input":"","input-debounce":"0"},Ie({error:s(()=>[l("label",{class:i(t.$q.dark.isActive?"text-red-4":"text-negative")},p(u.value.customer_id.message),3)]),"no-option":s(()=>[o(y,null,{default:s(()=>[o(q,{class:"text-grey"},{default:s(()=>[_(" No hay resultados ")]),_:1})]),_:1})]),_:2},[r.value.customer_id&&r.value.customer_id!=="CONSUMIDOR FINAL"?{name:"append",fn:s(()=>[o(S,{name:"cancel",onClick:e[0]||(e[0]=Re(a=>r.value.customer_id="CONSUMIDOR FINAL",["stop","prevent"])),class:"cursor-pointer"})]),key:"0"}:void 0]),1032,["modelValue","options","error"])]),n(c).roles[0]=="SUPER-ADMINISTRADOR"||n(c).roles[0]=="ADMINISTRADOR"?(m(),M("div",{key:0,class:i(["col-xs-12 col-md-5 q-mt-md",t.$q.screen.width<=1023?"q-pl-none":"offset-1"])},[Ge,o(B,{filled:"",modelValue:n(v),"onUpdate:modelValue":[e[3]||(e[3]=a=>P(v)?v.value=a:null),e[4]||(e[4]=a=>(u.value.sucursal_id.isValid=!0,x.value=[]))],error:!u.value.sucursal_id.isValid,options:E.value,"emit-value":"","map-options":"",dense:""},{error:s(()=>[l("label",{class:i(t.$q.dark.isActive?"text-red-4":"text-negative")},p(u.value.sucursal_id.message),3)]),"no-option":s(()=>[o(y,null,{default:s(()=>[o(q,{class:"text-grey"},{default:s(()=>[_(" No se encontro sucursal ")]),_:1})]),_:1})]),_:1},8,["modelValue","error","options"])],2)):L("",!0)]),l("div",Ye,[l("div",Je,[Ke,o(O,{outlined:"","bottom-slots":"",loading:n(le),dense:"",modelValue:n(A),"onUpdate:modelValue":e[6]||(e[6]=a=>P(A)?A.value=a:null),modelModifiers:{trim:!0},onKeyup:Oe(ge,["enter"])},{append:s(()=>[n(A)!==""?(m(),g(S,{key:0,name:"close",onClick:e[5]||(e[5]=a=>A.value=""),class:"cursor-pointer"})):L("",!0),o(S,{name:"search"})]),_:1},8,["loading","modelValue","onKeyup"])]),l("div",{class:i(["col-xs-12 col-sm-5",t.$q.screen.width<=1023?"q-pl-none q-mb-lg":"offset-1"])},[Ze,o(B,{dense:"",modelValue:r.value.forma_pago,"onUpdate:modelValue":[e[7]||(e[7]=a=>r.value.forma_pago=a),e[8]||(e[8]=a=>u.value.forma_pago.isValid=!0)],modelModifiers:{trim:!0},filled:"","emit-value":"","map-options":"",error:!u.value.forma_pago.isValid,options:[{label:"SIN UTILIZACION DEL SISTEMA FINANCIERO",value:"01"},{label:"COMPENSACI\xD3N DE DEUDAS",value:"15"},{label:"TARJETA DE D\xC9BITO",value:"16"},{label:"DINERO ELECTR\xD3NICO",value:"17"},{label:"TARJETA PREPAGO",value:"18"},{label:"TARJETA DE CR\xC9DITO",value:"19"},{label:"OTROS CON UTILIZACI\xD3N DEL SISTEMA FINANCIERO",value:"20"},{label:"ENDOSO DE T\xCDTULOS",value:"21"}]},{error:s(()=>[l("label",{class:i(t.$q.dark.isActive?"text-red-4":"text-negative")},p(u.value.forma_pago.message),3)]),_:1},8,["modelValue","error"])],2)])]),_:1})]),_:1}),o(De,{onSubmit:e[16]||(e[16]=a=>R("EMISION"))},{default:s(()=>[l("div",He,[l("div",We,[o(Ve,{rows:n(x),columns:n(j),"row-key":"name",class:i([t.$q.dark.isActive?"":"my-sticky-header-table3"]),"hide-pagination":!0,"rows-per-page-options":[50]},{"no-data":s(({})=>[l("div",Xe,[ea,o(S,{size:"2em",name:"playlist_add"})])]),"body-cell-cantidad":s(a=>[o(C,{props:a,class:"flex flex-center"},{default:s(()=>[o(O,{"input-class":"resaltarTextoInput",dense:"",required:"",onChange:d=>n(T)(a.row,"ventas"),min:"0",max:a.row.stock,readonly:a.row.tipo=="Servicio",type:"number",style:{width:"80px"},modelValue:a.row.cantidad,"onUpdate:modelValue":d=>a.row.cantidad=d,modelModifiers:{trim:!0}},null,8,["onChange","max","readonly","modelValue","onUpdate:modelValue"])]),_:2},1032,["props"])]),"body-cell-descuento":s(a=>[o(C,{props:a,class:"flex flex-center"},{default:s(()=>[o(O,{"input-class":"resaltarTextoInput",dense:"",required:"",onChange:d=>n(T)(a.row,"ventas"),min:"0",type:"number",style:{width:"100px"},modelValue:a.row.descuento,"onUpdate:modelValue":d=>a.row.descuento=d},null,8,["onChange","modelValue","onUpdate:modelValue"])]),_:2},1032,["props"])]),"body-cell-iva":s(a=>[o(C,{props:a},{default:s(()=>[_(p(a.row.aplicaIva?"SI":"NO"),1)]),_:2},1032,["props"])]),"body-cell-pvp":s(a=>[o(C,{props:a,class:"flex flex-center"},{default:s(()=>[o(O,{"input-class":"resaltarTextoInput",dense:"",required:"",onChange:d=>n(T)(a.row,"ventas"),min:"0",type:"number",style:{width:"100px"},modelValue:a.row.pvp,"onUpdate:modelValue":d=>a.row.pvp=d},null,8,["onChange","modelValue","onUpdate:modelValue"])]),_:2},1032,["props"])]),"body-cell-acciones":s(a=>[o(C,{props:a},{default:s(()=>[o(X,{round:"",color:"deep-orange",onClick:d=>n(re)(a.row.id),icon:"close",size:"8px"},null,8,["onClick"])]),_:2},1032,["props"])]),_:1},8,["rows","columns","class"])]),o(H,{class:"q-mt-md"},{default:s(()=>[o(W,{class:"q-pt-none row"},{default:s(()=>[l("div",{class:i(["col-xs-12 col-sm-8 col-md-7 row items-center q-mt-md",t.$q.screen.width<=1023?"q-mt-lg q-mb-sm":""])},[l("div",aa,[l("div",{class:i(["col-xs-12 col-sm-5 col-md-3 flex flex-center",t.$q.screen.xs?"text-center":"text-right"])},ta,2),l("div",sa,[o(O,{modelValue:r.value.descripcion,"onUpdate:modelValue":e[9]||(e[9]=a=>r.value.descripcion=a),filled:"",type:"textarea",rows:"4"},null,8,["modelValue"])])]),l("div",oa,[o(Ce,{"left-label":"",size:"xl",modelValue:F.value,"onUpdate:modelValue":e[10]||(e[10]=a=>F.value=a),label:"Enviar mensaje al cliente",color:"deep-orange-9","checked-icon":"task_alt","unchecked-icon":"highlight_off"},null,8,["modelValue"])])],2),l("div",ra,[l("table",{class:i([t.$q.screen.xs?"":"linearTablaDetalle"])},[l("tr",na,[ia,l("td",da," $"+p(n(f).subtotal.toFixed(2)),1)]),l("tr",ua,[ca,l("td",ma," $"+p(n(f).descuento.toFixed(2)),1)]),l("tr",pa,[va,l("td",fa," $"+p(n(oe)(n(f).subtotal-n(f).descuento).toFixed(2)),1)]),l("tr",_a,[l("td",null,[l("b",null,"IVA("+p(n(G))+"%):",1)]),l("td",ga," $"+p(n(f).iva.toFixed(2)),1)]),l("tr",ba,[ha,l("td",xa,[o(Se,{outline:"",class:"text-subtitle1 text-weight-bold",color:"secondary",label:`$${n(f).total.toFixed(2)}`},null,8,["label"])])])],2)]),l("div",{class:i(["col-12 flex q-mt-md q-my-lg",[t.$q.screen.width<600?"justify-center":"justify-between"]])},[t.$q.screen.width>600?(m(),g(X,{key:0,icon:"arrow_back",onClick:e[11]||(e[11]=a=>t.$router.push("/ventas")),outline:"",rounded:"",class:"q-mr-lg",color:t.$q.dark.isActive?"blue-grey-2":"blue-grey-10"},{default:s(()=>[_(" \xA0 Regresar ")]),_:1},8,["color"])):L("",!0),t.$route.params.venta_id==""?(m(),g(ae,{key:1,outline:"",rounded:"",style:{color:"#696cff"},label:"Generar",class:i(t.$q.screen.width>=1023?"q-px-xl":"full-width")},{default:s(()=>[o(ee,null,{default:s(()=>[D((m(),g(y,{clickable:"",onClick:e[12]||(e[12]=a=>R("FACTURA"))},{default:s(()=>[o(q,null,{default:s(()=>[o($,null,{default:s(()=>[_("FACTURA")]),_:1})]),_:1})]),_:1})),[[N]]),D((m(),g(y,{clickable:"",onClick:e[13]||(e[13]=a=>R("PROFORMA"))},{default:s(()=>[o(q,null,{default:s(()=>[o($,null,{default:s(()=>[_("PROFORMA")]),_:1})]),_:1})]),_:1})),[[N]])]),_:1})]),_:1},8,["class"])):(m(),g(ae,{key:2,outline:"",rounded:"",style:{color:"#696cff"},label:"Generar",class:i(t.$q.screen.width>=1023?"q-px-xl":"full-width")},{default:s(()=>[o(ee,null,{default:s(()=>[D((m(),g(y,{clickable:"",onClick:e[14]||(e[14]=a=>R("EMISION"))},{default:s(()=>[o(q,null,{default:s(()=>[o($,null,{default:s(()=>[_("Emitir Factura")]),_:1})]),_:1})]),_:1})),[[N]]),D((m(),g(y,{clickable:"",onClick:e[15]||(e[15]=a=>R("PROFORMA"))},{default:s(()=>[o(q,null,{default:s(()=>[o($,null,{default:s(()=>[_("Guardar Cambios")]),_:1})]),_:1})]),_:1})),[[N]])]),_:1})]),_:1},8,["class"]))],2)]),_:1})]),_:1})])]),_:1}),o(ye,{modelValue:n(V),"onUpdate:modelValue":e[17]||(e[17]=a=>P(V)?V.value=a:null)},{default:s(()=>[o(Ee,{listProductos:n(te),onAgregarProduct:pe},null,8,["listProductos"])]),_:1},8,["modelValue"])],64))}};export{Qa as default};
