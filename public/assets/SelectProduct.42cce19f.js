import{r as c,n as M,d as Q,o as k,a9 as A,g as t,aU as R,f as r,aV as F,e as B,ae as V,ad as D,h as q,i as x,aa as g,ab as _}from"./index.474519f9.js";import{Q as T,a as f}from"./QTable.fc9a2d60.js";import{Q as $}from"./QInnerLoading.8ecaf7db.js";import{u as O}from"./useHelpers.a0dac464.js";const v=c([]),y=c(""),u=c(!1),N=c({}),w=c(!1),C=c(""),z=c([{name:"acciones",label:"Quitar",align:"left"},{label:"Codigo Barra",align:"left",field:"codigoBarra",name:"codigoBarra"},{label:"Producto",align:"left",field:"nombre",name:"nombre"},{name:"cantidad",label:"Cantidad",align:"left"},{name:"iva",label:"Aplica IVA",align:"center"},{name:"descuento",label:"descuento %",align:"left",field:"descuento"},{label:"Stock",align:"center",field:"stock",name:"stock"},{name:"pvm",label:"Costo Neto",align:"center"},{name:"v_total",label:"Valor Total",align:"center",field:"v_total"}]),E=()=>{const d=c(0),{api:b,mostrarNotify:s,claim:n}=O(),p=(e,a)=>{if(v.value.some(o=>o.codigoBarra==e.codigoBarra))s("warning","Ya fue agregado este articulo");else{if(a!=="compras"&&e.stock<=0&&e.tipo!="Servicio")return s("negative",`No hay stock del articulo ${e.nombre}`);let o=0;a=="proforma"?o=e.cantidad:e.tipo=="Servicio"?o=1:o=0,e.cantidad=o,e.v_total=a=="proforma"?e.v_total:0,e.descuento=a=="venta"||a=="proforma"?e.descuento:0,v.value.unshift(e),e.tipo=="Servicio"&&P(e,"ventas"),y.value=""}},h=async e=>{if(y.value.length==0)return s("warning","Ingresa el termino de busqueda");u.value=!0;try{let a={company_id:n.company.id},{data:l}=await b.get(`/products/${y.value}`,{headers:a});if(l=l.filter(o=>{if(e=="compras"&&o.tipo=="Producto"||e=="venta")return o}),l.length>1)return N.value={data:l,tipo:e},w.value=!0,u.value=!1;if(l.length===0)return s("warning","No se encontro el articulo..."),u.value=!1;if(n.roles[0]=="ADMINISTRADOR"||n.roles[0]=="SUPER-ADMINISTRADOR"){if(C.value!==l[0].sucursal_id.id)return s("warning","No se encontro el articulo..."),u.value=!1}else if(n.sucursales[0]!==l[0].sucursal_id.id)return s("warning","No se encontro el articulo..."),u.value=!1;u.value=!1,p(l[0],e)}catch(a){console.log(a),u.value=!1}},m=e=>{const a=v.value.findIndex(l=>l.id==e);v.value.splice(a,1)},S=async()=>{const{data:{iva:e}}=await b.get(`/companies/get-iva/${n.company.id}`);e=="4"&&(d.value=15),e=="3"&&(d.value=14),e=="2"&&(d.value=12)},I=M(()=>{let e=0,a=0,l=0,o=0;return v.value.forEach(i=>{i.descuento>0&&(l+=parseFloat(i.v_total)*parseFloat(i.descuento)/100),i.aplicaIva&&(a+=(parseFloat(i.v_total)-parseFloat(i.v_total)*parseFloat(i.descuento)/100)*d.value/100),e+=parseFloat(i.v_total)}),o=e+a-l,{subtotal:parseFloat((Math.floor(e*100)/100).toString()),iva:parseFloat((Math.floor(a*100)/100).toString()),descuento:parseFloat((Math.floor(l*100)/100).toString()),total:parseFloat((Math.floor(o*100)/100).toString())}}),P=(e,a="compras")=>{a=="compras"?e.v_total=parseFloat(e.cantidad)*parseFloat((Math.floor(e.precio_compra*100)/100).toString()):e.v_total=parseFloat(e.cantidad)*parseFloat((Math.floor(e.pvp*100)/100).toString())};return S(),{agregarAndValidarStock:p,columns:z,claim:n,filterArticulo:h,filterByCodBarra:y,loadingState:u,listProductos:N,modalSelectProducto:w,sucursal_selected:C,iva_selected:d,getSubtotalByProduct:P,quitarArticulo:m,valorFactura:I,rows:v}};const U=B("div",{class:"text-h6 text-center"},"Selecciona un producto",-1),H={class:"row q-gutter-sm"},L={class:"col-xs-12 col-sm-12 q-my-sm"},K=Q({__name:"SelectProduct",props:{listProductos:{}},emits:["agregarProduct"],setup(d,{emit:b}){const s=d,n=[{name:"add",label:"Agregar"},{name:"codigoBarra",label:"Codigo Barra",align:"left",field:"codigoBarra"},{name:"producto",label:"Producto",align:"left",field:"nombre"},{name:"stock",label:"Stock",align:"center",field:"stock"},{name:"aplicaIva",label:"Aplica IVA",align:"center",field:"aplicaIva"},{name:"pvm",label:"Precio de Compra",align:"center",field:"pvm"},{name:"pvp",label:"P.V.P",align:"center",field:"pvp"},{name:"sucursal",label:"Sucursal",align:"center",field:"sucursal"}],{claim:p,sucursal_selected:h}=E();let m;p.roles[0]=="ADMINISTRADOR"||p.roles[0]=="SUPER-ADMINISTRADOR"?m=h.value:m=p.sucursales[0];const S=c([]);return s.listProductos.tipo,S.value=s.listProductos.data,(I,P)=>(k(),A(R,{style:{width:"1040px","max-width":"80vw"}},{default:t(()=>[r(F,{class:"q-pb-none"},{default:t(()=>[U]),_:1}),r(F,null,{default:t(()=>[B("div",H,[B("div",L,[r(T,{class:V([I.$q.dark.isActive?"":"my-sticky-header-table2"]),rows:S.value,columns:n,"hide-bottom":"","row-key":"name"},{"body-cell-add":t(e=>[r(f,{props:e},{default:t(()=>[D(m)==e.row.sucursal_id.id?(k(),A(q,{key:0,round:"",color:"green-9",class:"q-ml-md",size:"sm",onClick:a=>b("agregarProduct",e.row),icon:"fa-solid fa-plus"},null,8,["onClick"])):(k(),A(x,{key:1,color:"red-9",class:"q-ml-md",size:"sm",name:"fa-solid fa-ban"}))]),_:2},1032,["props"])]),"body-cell-descuento":t(e=>[r(f,{props:e},{default:t(()=>[g(_(e.row.descuento)+"% ",1)]),_:2},1032,["props"])]),"body-cell-aplicaIva":t(e=>[r(f,{props:e},{default:t(()=>[g(_(e.row.aplicaIva?"SI":"NO"),1)]),_:2},1032,["props"])]),"body-cell-pvp":t(e=>[r(f,{props:e},{default:t(()=>[g("$"+_(e.row.pvp),1)]),_:2},1032,["props"])]),"body-cell-pvm":t(e=>[r(f,{props:e},{default:t(()=>[g("$"+_(e.row.precio_compra),1)]),_:2},1032,["props"])]),"body-cell-sucursal":t(e=>[r(f,{props:e},{default:t(()=>[g(_(e.row.sucursal_id.nombre),1)]),_:2},1032,["props"])]),loading:t(()=>[r($,{showing:"",color:"primary"})]),_:1},8,["class","rows"])])])]),_:1})]),_:1}))}});export{K as _,E as u};
