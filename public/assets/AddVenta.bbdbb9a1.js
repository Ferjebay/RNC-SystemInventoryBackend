import{Q as pe,a as k}from"./QBreadcrumbs.c09b2328.js";import{Q as ve}from"./QSpinnerFacebook.41b9105f.js";import{r as v,v as fe,x as ge,o as x,c as U,e as t,ae as u,f as s,g as o,aU as H,ad as r,bb as F,ba as _e,aj as be,by as he,P as Q,aV as K,aa as _,ab as m,a9 as P,bB as xe,i as W,w as qe,af as M,B as we,al as ye,Q as I,h as L,bj as Ae}from"./index.c1e9c266.js";import{a as C,Q as S,d as Ve}from"./format.94f2824d.js";import{Q as $}from"./QSelect.90934d7a.js";import{Q as y}from"./QTd.73524116.js";import{Q as Ie}from"./QTable.fe6d5a67.js";import{Q as Ce}from"./QBadge.26100003.js";import{Q as Se}from"./QForm.db23952a.js";import{u as $e}from"./useHelpers.b0f80051.js";import{d as De}from"./date.dd1f3776.js";import{_ as Ne}from"./SelectProduct.e472da63.js";import{u as Oe}from"./useProduct.83317b93.js";import"./QList.6ef072d3.js";import"./use-quasar.01e618a9.js";import"./axios.e50523b2.js";import"./QInnerLoading.6590b929.js";const Re={class:"q-ma-lg q-pt-md q-mb-none",style:{"margin-bottom":"10px"}},Ee={class:"row q-col-gutter-lg flex items-center"},Te=t("label",{class:"text-h6 text-center"},"Nueva Factura",-1),ke=[Te],Ue={class:"text-weight-regular"},Fe=t("span",{class:"q-mr-sm"},"N\xB0 Factura:",-1),Qe={key:1,class:"text-weight-regular"},Pe={class:"col-xs-12 col-sm-12 col-md-6 q-mt-md q-pl-none"},Me=t("label",null,"Seleccionar Cliente: ",-1),Le=t("label",null,"Seleccionar Sucursal:",-1),Be={class:"col-xs-12 col-md-6 q-pl-none"},je=t("label",null,"Filtrar por codigo de barra o nombre del producto:",-1),ze=t("label",null,"Forma de pago:",-1),Ye={class:"q-mx-lg justify-center q-mt-md"},Je={class:"col-12"},Ge={class:"full-width row flex-center text-lime-10 q-gutter-sm"},Ze=t("span",{class:"text-subtitle1"}," Agrega alg\xFAn Producto ",-1),He={class:"row",style:{width:"100%"}},Ke=t("label",{class:"q-pr-md"}," Descripci\xF3n (Opcional) ",-1),We=[Ke],Xe={class:"col-xs-12 col-sm-7 col-md-9"},ea={class:"q-ml-sm q-mt-md"},aa={class:"col-xs-12 col-sm-4 col-md-5",style:{display:"flex","justify-content":"end"}},ta={class:"text-right"},la=t("td",null,[t("b",null,"TOTAL BRUTO:")],-1),sa={style:{width:"50px"},class:"text-subtitle1 text-weight-regular"},oa={class:"text-right"},ra=t("td",null,[t("b",null,"DESCUENTOS:")],-1),na={style:{width:"50px"},class:"text-subtitle1 text-weight-regular"},ia={class:"text-right"},ua=t("td",null,[t("b",null,"SUBTOTAL:")],-1),da={style:{width:"50px"},class:"text-subtitle1 text-weight-regular"},ca={class:"text-right"},ma={style:{width:"50px"},class:"text-subtitle1 text-weight-regular"},pa={class:"text-right"},va=t("td",null,[t("b",null,"TOTAL DE VENTA:")],-1),fa={style:{width:"50px"}},Ta={__name:"AddVenta",setup(ga){const{filterByCodBarra:A,columns:B,rows:b,modalSelectProducto:V,loadingState:D,listProductos:X,valorFactura:f,agregarAndValidarStock:j,formatearNumero:ee,getSubtotalByProduct:N,sucursal_selected:p,iva_selected:z,quitarArticulo:ae}=Oe();let Y=[];const g=v([]),{api:q,claim:c,mostrarNotify:w,route:_a,router:te}=$e(),O=v([]),le=v(!1),R=v(!1),E=v(!0),se=v(""),h=v([]),T=v([]),oe=Date.now();let re=De.formatDate(oe,"DD/MM/YYYY");(c.roles[0]!=="SUPER-ADMINISTRADOR"||c.roles[0]!=="ADMINISTRADOR")&&(p.value=c.sucursales[0]),B.value[7]={name:"pvp",label:"Precio de Venta",align:"center"};const i=v({customer_id:"5e909ecb-81f5-4cab-a663-ce3786c0db49",numero_comprobante:"--- --- ---------",products:[],user_id:"",forma_pago:"",descripcion:""}),d=v({customer_id:{message:"",isValid:!0},sucursal_id:{message:"",isValid:!0},forma_pago:{message:"",isValid:!0}});fe(p,(l,a)=>{G(),Z()});const ne=async l=>{O.value=[];const{data:a}=await q.get(`/sucursal/find/${l}/company`);a.forEach(e=>{O.value.push({label:e.nombre,value:e.id})})},ie=l=>{j(l,"venta"),V.value=!1},ue=async()=>{const l=i.value.customer_id;i.value.customer_id="",le.value=!1;try{let a={"company-id":c.company.id};const{data:e}=await q.get("/customers",{headers:a});g.value=[],e.forEach(n=>{g.value.push({label:n.nombres,value:n.id,num_doc:n.numero_documento})}),g.value.unshift({label:"CONSUMIDOR FINAL",value:"5e909ecb-81f5-4cab-a663-ce3786c0db49",num_doc:"9999999999999"}),Y=g.value,i.value.customer_id=l}catch(a){console.log(a)}},de=(l="",a)=>{if(l==="")return a(()=>{g.value=Y});a(()=>{const e=l.toLowerCase();g.value=g.value.filter(n=>n.num_doc.indexOf(e)>-1||n.label.toLowerCase().indexOf(e)>-1)})},ce=l=>{let a=!1;return(c.roles[0]=="SUPER-ADMINISTRADOR"||c.roles[0]=="ADMINISTRADOR")&&p.value==""&&(d.value.sucursal_id.message="Debes seleccionar una sucursal",d.value.sucursal_id.isValid=!1,a=!0),f.value.total>50&&i.value.customer_id=="5e909ecb-81f5-4cab-a663-ce3786c0db49"&&l!="PROFORMA"&&(d.value.customer_id.message="La factura supera los $50.00, no puede ser emitida a CONSUMIDOR FINAL",d.value.customer_id.isValid=!1,a=!0),f.value.total>50&&i.value.forma_pago=="01"&&(d.value.forma_pago.message="La factura supera los $500.00, debes elegir otra forma de pago",d.value.forma_pago.isValid=!1,a=!0),b.value.length==0&&(a=!0,w("warning","Debes agregar algun producto..")),i.value.forma_pago.length==0&&(d.value.forma_pago.message="Debes elegir una forma de pago",d.value.forma_pago.isValid=!1,a=!0),b.value.forEach((e,n)=>{e.cantidad<=0&&(a=!0,w("warning",`Agrega una cantidad cantidad al producto: ${e.nombre} de la fila: ${n+1}`)),e.cantidad>e.stock&&e.tipo!="Servicio"&&(a=!0,w("warning",`La cantidad de venta del producto: ${e.nombre} supera su stock disponible`))}),a},J=async l=>{ce(l)||(i.value={...i.value,...f.value,products:b.value,user_id:c.id,tipo:l,send_messages:E,porcentaje_iva:z.value,name_proforma:se.value},he.create({title:"\xBFDeseas generar esta Factura?",ok:{push:!0,color:"cyan-10",label:"Enviar"},cancel:{push:!0,color:"blue-grey-6",label:"Cancelar"}}).onOk(async()=>{try{Q.show({message:"Cargando..."});let a={headers:{"sucursal-id":p.value}};await q.post("/invoices",i.value,a),Q.hide(),w("positive","Venta realizada exitosamente"),te.push("/ventas")}catch(a){w("warning",a.response.data.message),Q.hide()}}))},G=async()=>{R.value=!0;let l={headers:{"sucursal-id":p.value}};const{data:a}=await q.get("/CE/facturas/getNumFactura",l);i.value.numero_comprobante=a.numComprobante,R.value=!1};ge(()=>{b.value=[]});const Z=async()=>{D.value=!0;let l={"sucursal-id":p.value};try{const{data:a}=await q.get("/products",{params:{page:1,limit:1e5,busqueda:""},headers:l});h.value=[],a.items.forEach(e=>{h.value.push({label:e.nombre,value:e.id,detalles:e})}),T.value=h.value,D.value=!1}catch(a){console.log(a)}},me=(l="",a)=>{if(l===""){a(()=>{h.value=T.value});return}a(()=>{const e=l.toLowerCase();h.value=T.value.filter(n=>n.label.toLowerCase().indexOf(e)>-1)})};return c.roles[0]=="SUPER-ADMINISTRADOR"||c.roles[0]=="ADMINISTRADOR"?ne(c.company.id):(p.value=c.sucursales[0],G(),Z()),ue(),(l,a)=>(x(),U(be,null,[t("div",Re,[t("div",Ee,[t("div",{class:u(["col-xs-12 col-md-6",[(l.$q.screen.width<1022,"q-pt-sm")]])},[s(pe,{class:u(["row q-mr-xs",[l.$q.screen.width<1022?"justify-center q-pt-sm":"justify-start "]])},{default:o(()=>[s(k,{label:"Inicio",icon:"home",to:"/"}),s(k,{label:"Facturas",icon:"payments",to:"/ventas"}),s(k,{label:"Factura",icon:"add_circle"})]),_:1},8,["class"])],2),t("div",{class:u(["col-xs-12 col-md-6",[l.$q.screen.width<1022?"text-center q-pt-sm":"text-right q-pt-sm"]])},ke,2)])]),s(H,{class:"q-mx-lg q-mt-lg"},{default:o(()=>[s(K,{class:"q-pt-none"},{default:o(()=>[t("div",{class:u(["row q-col-gutter-md",[l.$q.screen.xs?"q-mx-xs":"q-mx-lg"]])},[t("div",{class:u(["col-xs-12 col-md-6 q-pt-xs q-mt-md",l.$q.screen.width>=1023||"text-center q-pl-none"])},[t("label",{class:u(["text-weight-medium",[l.$q.screen.xs?"text-subtitle1":"text-h5"]])},[_("Fecha de Emisi\xF3n: "),t("span",Ue,m(r(re)),1)],2)],2),t("div",{class:u(["col-xs-12 col-md-6",l.$q.screen.width<=1023?"text-center q-pt-sm q-pl-none":"text-right q-pt-xs q-mt-md"])},[t("label",{class:u(["text-weight-medium",[l.$q.screen.xs?"text-subtitle1":"text-h5 q-mr-lg"]])},[Fe,R.value?(x(),P(ve,{key:0,color:"primary",class:"q-ml-md",size:"2em"})):(x(),U("span",Qe,m(i.value.numero_comprobante),1))],2)],2),t("div",Pe,[Me,s($,{color:"orange",filled:"",modelValue:i.value.customer_id,"onUpdate:modelValue":[a[1]||(a[1]=e=>i.value.customer_id=e),a[2]||(a[2]=e=>d.value.customer_id.isValid=!0)],options:g.value,"emit-value":"","map-options":"",dense:"",error:!d.value.customer_id.isValid,onFilter:de,"use-input":"","input-debounce":"0"},xe({error:o(()=>[t("label",{class:u(l.$q.dark.isActive?"text-red-4":"text-negative")},m(d.value.customer_id.message),3)]),"no-option":o(()=>[s(C,null,{default:o(()=>[s(S,{class:"text-grey"},{default:o(()=>[_(" No hay resultados ")]),_:1})]),_:1})]),_:2},[i.value.customer_id&&i.value.customer_id!=="CONSUMIDOR FINAL"?{name:"append",fn:o(()=>[s(W,{name:"cancel",onClick:a[0]||(a[0]=qe(e=>i.value.customer_id="CONSUMIDOR FINAL",["stop","prevent"])),class:"cursor-pointer"})]),key:"0"}:void 0]),1032,["modelValue","options","error"])]),r(c).roles[0]=="SUPER-ADMINISTRADOR"||r(c).roles[0]=="ADMINISTRADOR"?(x(),U("div",{key:0,class:u(["col-xs-12 col-md-5",l.$q.screen.width<=1023?"q-pl-none q-mt-xs":"offset-1 q-mt-md"])},[Le,s($,{filled:"",modelValue:r(p),"onUpdate:modelValue":[a[3]||(a[3]=e=>F(p)?p.value=e:null),a[4]||(a[4]=e=>(d.value.sucursal_id.isValid=!0,b.value=[]))],error:!d.value.sucursal_id.isValid,options:O.value,"emit-value":"","map-options":"",dense:""},{error:o(()=>[t("label",{class:u(l.$q.dark.isActive?"text-red-4":"text-negative")},m(d.value.sucursal_id.message),3)]),"no-option":o(()=>[s(C,null,{default:o(()=>[s(S,{class:"text-grey"},{default:o(()=>[_(" No se encontro sucursal ")]),_:1})]),_:1})]),_:1},8,["modelValue","error","options"])],2)):M("",!0)],2),t("div",{class:u(["row q-pt-lg q-col-gutter-md",[l.$q.screen.xs?"q-mx-xs":"q-mx-lg"]])},[t("div",Be,[je,s($,{filled:"",modelValue:r(A),"onUpdate:modelValue":[a[5]||(a[5]=e=>F(A)?A.value=e:null),a[6]||(a[6]=e=>r(j)(r(A).detalles,"venta"))],dense:"",options:h.value,onFilter:me,"use-input":"","input-debounce":"900"},{"no-option":o(()=>[s(C,null,{default:o(()=>[s(S,{class:"text-grey"},{default:o(()=>[_(" No hay resultados ")]),_:1})]),_:1})]),append:o(()=>[r(D)?(x(),P(we,{key:0,size:"1.2rem"})):M("",!0)]),option:o(e=>[s(C,ye(e.itemProps,{class:r(b).some(n=>n.id==e.opt.value)?l.$q.dark.isActive?"bg-indigo-4":"bg-indigo-1":""}),{default:o(()=>[s(S,null,{default:o(()=>[s(Ve,null,{default:o(()=>[_(m(e.opt.label),1)]),_:2},1024)]),_:2},1024)]),_:2},1040,["class"])]),_:1},8,["modelValue","options"])]),t("div",{class:u(["col-xs-12 col-sm-5",l.$q.screen.width<=1023?"q-pl-none q-mb-sm q-mt-md":"offset-1"])},[ze,s($,{dense:"",modelValue:i.value.forma_pago,"onUpdate:modelValue":[a[7]||(a[7]=e=>i.value.forma_pago=e),a[8]||(a[8]=e=>d.value.forma_pago.isValid=!0)],modelModifiers:{trim:!0},filled:"","emit-value":"","map-options":"",error:!d.value.forma_pago.isValid,options:[{label:"SIN UTILIZACION DEL SISTEMA FINANCIERO",value:"01"},{label:"COMPENSACI\xD3N DE DEUDAS",value:"15"},{label:"TARJETA DE D\xC9BITO",value:"16"},{label:"DINERO ELECTR\xD3NICO",value:"17"},{label:"TARJETA PREPAGO",value:"18"},{label:"TARJETA DE CR\xC9DITO",value:"19"},{label:"OTROS CON UTILIZACI\xD3N DEL SISTEMA FINANCIERO",value:"20"},{label:"ENDOSO DE T\xCDTULOS",value:"21"}]},{error:o(()=>[t("label",{class:u(l.$q.dark.isActive?"text-red-4":"text-negative")},m(d.value.forma_pago.message),3)]),_:1},8,["modelValue","error"])],2)],2)]),_:1})]),_:1}),s(Se,{onSubmit:a[13]||(a[13]=e=>J("EMISION"))},{default:o(()=>[t("div",Ye,[t("div",Je,[s(Ie,{rows:r(b),columns:r(B),"row-key":"name",class:u([l.$q.dark.isActive?"":"my-sticky-header-table3"]),"hide-pagination":!0,"rows-per-page-options":[50]},{"no-data":o(({})=>[t("div",Ge,[Ze,s(W,{size:"2em",name:"playlist_add"})])]),"body-cell-cantidad":o(e=>[s(y,{props:e,class:"flex flex-center"},{default:o(()=>[s(I,{"input-class":"resaltarTextoInput",dense:"",required:"",onChange:n=>r(N)(e.row,"ventas"),min:"0",max:e.row.stock,type:"number",style:{width:"80px"},modelValue:e.row.cantidad,"onUpdate:modelValue":n=>e.row.cantidad=n,modelModifiers:{trim:!0}},null,8,["onChange","max","modelValue","onUpdate:modelValue"])]),_:2},1032,["props"])]),"body-cell-descuento":o(e=>[s(y,{props:e,class:"flex flex-center"},{default:o(()=>[s(I,{"input-class":"resaltarTextoInput",dense:"",required:"",onChange:n=>r(N)(e.row,"ventas"),min:"0",type:"number",style:{width:"100px"},modelValue:e.row.descuento,"onUpdate:modelValue":n=>e.row.descuento=n},null,8,["onChange","modelValue","onUpdate:modelValue"])]),_:2},1032,["props"])]),"body-cell-iva":o(e=>[s(y,{props:e},{default:o(()=>[_(m(e.row.aplicaIva?"SI":"NO"),1)]),_:2},1032,["props"])]),"body-cell-pvp":o(e=>[s(y,{props:e,class:"flex flex-center"},{default:o(()=>[s(I,{"input-class":"resaltarTextoInput",dense:"",required:"",onChange:n=>r(N)(e.row,"ventas"),min:"0",type:"number",style:{width:"100px"},modelValue:e.row.pvp,"onUpdate:modelValue":n=>e.row.pvp=n},null,8,["onChange","modelValue","onUpdate:modelValue"])]),_:2},1032,["props"])]),"body-cell-acciones":o(e=>[s(y,{props:e},{default:o(()=>[s(L,{round:"",color:"deep-orange",onClick:n=>r(ae)(e.row.id),icon:"close",size:"8px"},null,8,["onClick"])]),_:2},1032,["props"])]),_:1},8,["rows","columns","class"])]),s(H,{class:"q-mt-md"},{default:o(()=>[s(K,{class:"q-pt-none row"},{default:o(()=>[t("div",{class:u(["col-xs-12 col-sm-8 col-md-7 row items-center q-mt-md",l.$q.screen.width<=1023?"q-mt-lg q-mb-sm":""])},[t("div",He,[t("div",{class:u(["col-xs-12 col-sm-5 col-md-3 flex flex-center",l.$q.screen.xs?"text-center":"text-right"])},We,2),t("div",Xe,[s(I,{modelValue:i.value.descripcion,"onUpdate:modelValue":a[9]||(a[9]=e=>i.value.descripcion=e),filled:"",type:"textarea",rows:"4"},null,8,["modelValue"])])]),t("div",ea,[s(Ae,{"left-label":"",size:"xl",modelValue:E.value,"onUpdate:modelValue":a[10]||(a[10]=e=>E.value=e),label:"Enviar mensaje al cliente",color:"deep-orange-9","checked-icon":"task_alt","unchecked-icon":"highlight_off"},null,8,["modelValue"])])],2),t("div",aa,[t("table",{class:u([l.$q.screen.xs?"":"linearTablaDetalle"])},[t("tr",ta,[la,t("td",sa," $"+m(r(f).subtotal.toFixed(2)),1)]),t("tr",oa,[ra,t("td",na," $"+m(r(f).descuento.toFixed(2)),1)]),t("tr",ia,[ua,t("td",da," $"+m(r(ee)(r(f).subtotal-r(f).descuento).toFixed(2)),1)]),t("tr",ca,[t("td",null,[t("b",null,"IVA("+m(r(z))+"%):",1)]),t("td",ma," $"+m(r(f).iva.toFixed(2)),1)]),t("tr",pa,[va,t("td",fa,[s(Ce,{outline:"",class:"text-subtitle1 text-weight-bold",color:"secondary",label:`$${r(f).total.toFixed(2)}`},null,8,["label"])])])],2)]),t("div",{class:u(["col-12 flex q-mt-md q-my-lg",[l.$q.screen.width<600?"justify-center":"justify-between"]])},[l.$q.screen.width>600?(x(),P(L,{key:0,icon:"arrow_back",onClick:a[11]||(a[11]=e=>l.$router.push("/ventas")),outline:"",rounded:"",class:"q-mr-lg",color:l.$q.dark.isActive?"blue-grey-2":"blue-grey-10"},{default:o(()=>[_(" \xA0 Regresar ")]),_:1},8,["color"])):M("",!0),s(L,{onClick:a[12]||(a[12]=e=>J("FACTURA")),outline:"",rounded:"",style:{color:"#696cff"}},{default:o(()=>[_(" \xA0 GENERAR FACTURA ")]),_:1})],2)]),_:1})]),_:1})])]),_:1}),s(_e,{modelValue:r(V),"onUpdate:modelValue":a[14]||(a[14]=e=>F(V)?V.value=e:null)},{default:o(()=>[s(Ne,{listProductos:r(X),onAgregarProduct:ie},null,8,["listProductos"])]),_:1},8,["modelValue"])],64))}};export{Ta as default};
