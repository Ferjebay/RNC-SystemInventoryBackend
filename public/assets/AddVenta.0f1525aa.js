import{Q as he,a as U}from"./QBreadcrumbs.c09b2328.js";import{Q as xe}from"./QSpinnerFacebook.41b9105f.js";import{r as v,v as qe,x as ye,o as f,c as M,e as t,ae as d,f as o,g as s,aU as ee,ad as i,bb as L,ba as we,aj as Ae,by as Ie,P as B,aV as ae,aa as g,ab as m,a9 as x,bB as Ve,i as le,w as Oe,af as j,B as Ce,al as Se,Q as $,h as z,bj as $e,O as te}from"./index.c1e9c266.js";import{a as w,Q as A,d as G}from"./format.94f2824d.js";import{Q as R}from"./QSelect.90934d7a.js";import{Q as V}from"./QTd.73524116.js";import{Q as Re}from"./QTable.fe6d5a67.js";import{Q as De}from"./QBadge.26100003.js";import{Q as Ne}from"./QList.6ef072d3.js";import{Q as Ee}from"./QBtnDropdown.cafef135.js";import{Q as Te}from"./QForm.db23952a.js";import{C as se}from"./ClosePopup.e17be494.js";import{u as ke}from"./useHelpers.b0f80051.js";import{d as Pe}from"./date.dd1f3776.js";import{_ as Fe}from"./SelectProduct.e472da63.js";import{u as Qe}from"./useProduct.83317b93.js";import"./QBtnGroup.13e20355.js";import"./use-quasar.01e618a9.js";import"./axios.e50523b2.js";import"./QInnerLoading.6590b929.js";const Ue={class:"q-ma-lg q-pt-md q-mb-none",style:{"margin-bottom":"10px"}},Me={class:"row q-col-gutter-lg flex items-center"},Le=t("label",{class:"text-h6 text-center"},"Nueva Proforma",-1),Be=[Le],je={class:"text-weight-regular"},ze=t("span",{class:"q-mr-sm"},"N\xB0 Factura:",-1),Ge={key:1,class:"text-weight-regular"},Ye={class:"col-xs-12 col-sm-12 col-md-6 q-mt-md q-pl-none"},Je=t("label",null,"Seleccionar Cliente: ",-1),Ze=t("label",null,"Seleccionar Sucursal:",-1),He={class:"col-xs-12 col-md-6 q-pl-none"},Ke=t("label",null,"Filtrar por codigo de barra o nombre del producto:",-1),We=t("label",null,"Forma de pago:",-1),Xe={class:"q-mx-lg justify-center q-mt-md"},ea={class:"col-12"},aa={class:"full-width row flex-center text-lime-10 q-gutter-sm"},la=t("span",{class:"text-subtitle1"}," Agrega alg\xFAn Producto ",-1),ta={class:"row",style:{width:"100%"}},sa=t("label",{class:"q-pr-md"}," Descripci\xF3n (Opcional) ",-1),oa=[sa],ra={class:"col-xs-12 col-sm-7 col-md-9"},ia={class:"q-ml-sm q-mt-md"},na={class:"col-xs-12 col-sm-4 col-md-5",style:{display:"flex","justify-content":"end"}},da={class:"text-right"},ua=t("td",null,[t("b",null,"TOTAL BRUTO:")],-1),ca={style:{width:"50px"},class:"text-subtitle1 text-weight-regular"},ma={class:"text-right"},pa=t("td",null,[t("b",null,"DESCUENTOS:")],-1),va={style:{width:"50px"},class:"text-subtitle1 text-weight-regular"},fa={class:"text-right"},ga=t("td",null,[t("b",null,"SUBTOTAL:")],-1),_a={style:{width:"50px"},class:"text-subtitle1 text-weight-regular"},ba={class:"text-right"},ha={style:{width:"50px"},class:"text-subtitle1 text-weight-regular"},xa={class:"text-right"},qa=t("td",null,[t("b",null,"TOTAL DE VENTA:")],-1),ya={style:{width:"50px"}},ja={__name:"AddVenta",setup(wa){const{filterByCodBarra:O,columns:Y,rows:b,modalSelectProducto:C,loadingState:D,listProductos:oe,valorFactura:_,agregarAndValidarStock:N,formatearNumero:E,getSubtotalByProduct:T,sucursal_selected:p,iva_selected:J,quitarArticulo:re}=Qe();let Z=[];const h=v([]),{api:q,claim:c,mostrarNotify:I,route:H,router:ie}=ke(),k=v([]),ne=v(!1),P=v(!1),F=v(!0),K=v(""),y=v([]),Q=v([]),de=Date.now();let ue=Pe.formatDate(de,"DD/MM/YYYY");const ce="5e909ecb-81f5-4cab-a663-ce3786c0db49";(c.roles[0]!=="SUPER-ADMINISTRADOR"||c.roles[0]!=="ADMINISTRADOR")&&(p.value=c.sucursales[0]),Y.value[7]={name:"pvp",label:"Precio de Venta",align:"center"};const r=v({customer_id:"5e909ecb-81f5-4cab-a663-ce3786c0db49",numero_comprobante:"--- --- ---------",products:[],user_id:"",forma_pago:"",descripcion:""}),u=v({customer_id:{message:"",isValid:!0},sucursal_id:{message:"",isValid:!0},forma_pago:{message:"",isValid:!0}});qe(p,(l,e)=>{W(),X()});const me=async l=>{k.value=[];const{data:e}=await q.get(`/sucursal/find/${l}/company`);e.forEach(a=>{k.value.push({label:a.nombre,value:a.id})})},pe=async()=>{if(H.params.proforma_id!==""){const{data:l}=await q.get(`/invoices/filterInvoice/${H.params.proforma_id}`);r.value.customer_id=l.customer_id.id,r.value.id=l.id,r.value.clave_acceso=l.clave_acceso,r.value.estadoSRI=l.estadoSRI,r.value.forma_pago=l.forma_pago,r.value.descripcion=l.descripcion,p.value=l.sucursal_id.id,K.value=l.name_proforma,l.invoiceToProduct.forEach(e=>{e.product_id.cantidad=e.cantidad,e.product_id.descuento=parseFloat(e.descuento),e.product_id.v_total=e.v_total,e.product_id.pvp=parseFloat(e.v_total)/parseInt(e.cantidad),N(e.product_id,"proforma")})}},ve=l=>{N(l,"proforma"),C.value=!1},fe=async()=>{const l=r.value.customer_id;r.value.customer_id="",ne.value=!1;try{let e={"company-id":c.company.id};const{data:a}=await q.get("/customers",{headers:e});h.value=[],a.forEach(n=>{h.value.push({label:n.nombres,value:n.id,num_doc:n.numero_documento})}),h.value.unshift({label:"CONSUMIDOR FINAL",value:"5e909ecb-81f5-4cab-a663-ce3786c0db49",num_doc:"9999999999999"}),Z=h.value,r.value.customer_id=l,pe()}catch(e){console.log(e)}},ge=(l="",e)=>{if(l==="")return e(()=>{h.value=Z});e(()=>{const a=l.toLowerCase();h.value=h.value.filter(n=>n.num_doc.indexOf(a)>-1||n.label.toLowerCase().indexOf(a)>-1)})},_e=l=>{let e=!1;return(c.roles[0]=="SUPER-ADMINISTRADOR"||c.roles[0]=="ADMINISTRADOR")&&p.value==""&&(u.value.sucursal_id.message="Debes seleccionar una sucursal",u.value.sucursal_id.isValid=!1,e=!0),_.value.total>50&&r.value.customer_id=="5e909ecb-81f5-4cab-a663-ce3786c0db49"&&l!="PROFORMA"&&(u.value.customer_id.message="La factura supera los $50.00, no puede ser emitida a CONSUMIDOR FINAL",u.value.customer_id.isValid=!1,e=!0),_.value.total>50&&r.value.forma_pago=="01"&&(u.value.forma_pago.message="La factura supera los $500.00, debes elegir otra forma de pago",u.value.forma_pago.isValid=!1,e=!0),b.value.length==0&&(e=!0,I("warning","Debes agregar algun producto..")),r.value.forma_pago.length==0&&(u.value.forma_pago.message="Debes elegir una forma de pago",u.value.forma_pago.isValid=!1,e=!0),b.value.forEach((a,n)=>{a.cantidad<=0&&(e=!0,I("warning",`Agrega una cantidad cantidad al producto: ${a.nombre} de la fila: ${n+1}`)),a.cantidad>a.stock&&a.tipo!="Servicio"&&l=="EMISION"&&(e=!0,I("warning",`La cantidad de venta del producto: ${a.nombre} supera su stock disponible`))}),e},S=async l=>{if(_e(l))return;b.value.map(a=>{a.pvp=E(a.pvp),a.v_total=E(a.v_total)}),r.value={...r.value,..._.value,products:b.value,user_id:c.id,tipo:l,send_messages:F,porcentaje_iva:J.value,name_proforma:K.value};let e;l=="EMISION"&&(e="\xBFDeseas emitir factura de esta proforma?"),l=="FACTURA"&&(e="\xBFDeseas generar esta FACTURA?"),l=="PROFORMA"&&(e="\xBFDeseas generar esta Proforma?"),Ie.create({title:e,ok:{push:!0,color:"cyan-10",label:"Enviar"},cancel:{push:!0,color:"blue-grey-6",label:"Cancelar"}}).onOk(async()=>{try{B.show({message:"Cargando..."});let a={headers:{"sucursal-id":p.value}};await q.post("/invoices",r.value,a),B.hide(),I("positive","Venta realizada exitosamente"),ie.push("/proformas")}catch(a){I("warning",a.response.data.message),B.hide()}})},W=async()=>{P.value=!0;let l={headers:{"sucursal-id":p.value}};const{data:e}=await q.get("/CE/facturas/getNumFactura",l);r.value.numero_comprobante=e.numComprobante,P.value=!1};ye(()=>{b.value=[]});const X=async()=>{D.value=!0;let l={"sucursal-id":p.value};try{const{data:e}=await q.get("/products",{params:{page:1,limit:1e5,busqueda:""},headers:l});y.value=[],e.items.forEach(a=>{y.value.push({label:a.nombre,value:a.id,detalles:a})}),Q.value=y.value,D.value=!1}catch(e){console.log(e)}},be=(l="",e)=>{if(l===""){e(()=>{y.value=Q.value});return}e(()=>{const a=l.toLowerCase();y.value=Q.value.filter(n=>n.label.toLowerCase().indexOf(a)>-1)})};return c.roles[0]=="SUPER-ADMINISTRADOR"||c.roles[0]=="ADMINISTRADOR"?me(c.company.id):(p.value=c.sucursales[0],W(),X()),fe(),(l,e)=>(f(),M(Ae,null,[t("div",Ue,[t("div",Me,[t("div",{class:d(["col-xs-12 col-md-6",[(l.$q.screen.width<1022,"q-pt-sm")]])},[o(he,{class:d(["row q-mr-xs",[l.$q.screen.width<1022?"justify-center q-pt-sm":"justify-start "]])},{default:s(()=>[o(U,{label:"Inicio",icon:"home",to:"/"}),o(U,{label:"Proformas",icon:"payments",to:"/proformas"}),o(U,{label:"Proforma",icon:"add_circle"})]),_:1},8,["class"])],2),t("div",{class:d(["col-xs-12 col-md-6",[l.$q.screen.width<1022?"text-center q-pt-sm":"text-right q-pt-sm"]])},Be,2)])]),o(ee,{class:"q-mx-lg q-mt-lg"},{default:s(()=>[o(ae,{class:"q-pt-none"},{default:s(()=>[t("div",{class:d(["row q-col-gutter-md",[l.$q.screen.xs?"q-mx-xs":"q-mx-lg"]])},[t("div",{class:d(["col-xs-12 col-md-6 q-pt-xs q-mt-md",l.$q.screen.width>=1023||"text-center q-pl-none"])},[t("label",{class:d(["text-weight-medium",[l.$q.screen.xs?"text-subtitle1":"text-h5"]])},[g("Fecha de Emisi\xF3n: "),t("span",je,m(i(ue)),1)],2)],2),t("div",{class:d(["col-xs-12 col-md-6",l.$q.screen.width<=1023?"text-center q-pt-sm q-pl-none":"text-right q-pt-xs q-mt-md"])},[t("label",{class:d(["text-weight-medium",[l.$q.screen.xs?"text-subtitle1":"text-h5 q-mr-lg"]])},[ze,P.value?(f(),x(xe,{key:0,color:"primary",class:"q-ml-md",size:"2em"})):(f(),M("span",Ge,m(r.value.numero_comprobante),1))],2)],2),t("div",Ye,[Je,o(R,{color:"orange",filled:"",modelValue:r.value.customer_id,"onUpdate:modelValue":[e[1]||(e[1]=a=>r.value.customer_id=a),e[2]||(e[2]=a=>u.value.customer_id.isValid=!0)],options:h.value,"emit-value":"","map-options":"",dense:"",error:!u.value.customer_id.isValid,onFilter:ge,"use-input":"","input-debounce":"0"},Ve({error:s(()=>[t("label",{class:d(l.$q.dark.isActive?"text-red-4":"text-negative")},m(u.value.customer_id.message),3)]),"no-option":s(()=>[o(w,null,{default:s(()=>[o(A,{class:"text-grey"},{default:s(()=>[g(" No hay resultados ")]),_:1})]),_:1})]),_:2},[r.value.customer_id&&r.value.customer_id!=="CONSUMIDOR FINAL"?{name:"append",fn:s(()=>[o(le,{name:"cancel",onClick:e[0]||(e[0]=Oe(a=>r.value.customer_id=i(ce),["stop","prevent"])),class:"cursor-pointer"})]),key:"0"}:void 0]),1032,["modelValue","options","error"])]),i(c).roles[0]=="SUPER-ADMINISTRADOR"||i(c).roles[0]=="ADMINISTRADOR"?(f(),M("div",{key:0,class:d(["col-xs-12 col-md-5",l.$q.screen.width<=1023?"q-pl-none q-mt-xs":"offset-1 q-mt-md"])},[Ze,o(R,{filled:"",modelValue:i(p),"onUpdate:modelValue":[e[3]||(e[3]=a=>L(p)?p.value=a:null),e[4]||(e[4]=a=>(u.value.sucursal_id.isValid=!0,b.value=[]))],error:!u.value.sucursal_id.isValid,options:k.value,"emit-value":"","map-options":"",dense:""},{error:s(()=>[t("label",{class:d(l.$q.dark.isActive?"text-red-4":"text-negative")},m(u.value.sucursal_id.message),3)]),"no-option":s(()=>[o(w,null,{default:s(()=>[o(A,{class:"text-grey"},{default:s(()=>[g(" No se encontro sucursal ")]),_:1})]),_:1})]),_:1},8,["modelValue","error","options"])],2)):j("",!0)],2),t("div",{class:d(["row q-pt-lg q-col-gutter-md",[l.$q.screen.xs?"q-mx-xs":"q-mx-lg"]])},[t("div",He,[Ke,o(R,{filled:"",modelValue:i(O),"onUpdate:modelValue":[e[5]||(e[5]=a=>L(O)?O.value=a:null),e[6]||(e[6]=a=>i(N)(i(O).detalles,"proforma"))],dense:"",options:y.value,onFilter:be,"use-input":"","input-debounce":"900"},{"no-option":s(()=>[o(w,null,{default:s(()=>[o(A,{class:"text-grey"},{default:s(()=>[g(" No hay resultados ")]),_:1})]),_:1})]),append:s(()=>[i(D)?(f(),x(Ce,{key:0,size:"1.2rem"})):j("",!0)]),option:s(a=>[o(w,Se(a.itemProps,{class:i(b).some(n=>n.id==a.opt.value)?l.$q.dark.isActive?"bg-indigo-4":"bg-indigo-1":""}),{default:s(()=>[o(A,null,{default:s(()=>[o(G,null,{default:s(()=>[g(m(a.opt.label),1)]),_:2},1024)]),_:2},1024)]),_:2},1040,["class"])]),_:1},8,["modelValue","options"])]),t("div",{class:d(["col-xs-12 col-sm-5",l.$q.screen.width<=1023?"q-pl-none q-mb-sm q-mt-md":"offset-1"])},[We,o(R,{dense:"",modelValue:r.value.forma_pago,"onUpdate:modelValue":[e[7]||(e[7]=a=>r.value.forma_pago=a),e[8]||(e[8]=a=>u.value.forma_pago.isValid=!0)],modelModifiers:{trim:!0},filled:"","emit-value":"","map-options":"",error:!u.value.forma_pago.isValid,options:[{label:"SIN UTILIZACION DEL SISTEMA FINANCIERO",value:"01"},{label:"COMPENSACI\xD3N DE DEUDAS",value:"15"},{label:"TARJETA DE D\xC9BITO",value:"16"},{label:"DINERO ELECTR\xD3NICO",value:"17"},{label:"TARJETA PREPAGO",value:"18"},{label:"TARJETA DE CR\xC9DITO",value:"19"},{label:"OTROS CON UTILIZACI\xD3N DEL SISTEMA FINANCIERO",value:"20"},{label:"ENDOSO DE T\xCDTULOS",value:"21"}]},{error:s(()=>[t("label",{class:d(l.$q.dark.isActive?"text-red-4":"text-negative")},m(u.value.forma_pago.message),3)]),_:1},8,["modelValue","error"])],2)],2)]),_:1})]),_:1}),o(Te,{onSubmit:e[15]||(e[15]=a=>S("EMISION"))},{default:s(()=>[t("div",Xe,[t("div",ea,[o(Re,{rows:i(b),columns:i(Y),"row-key":"name",class:d([l.$q.dark.isActive?"":"my-sticky-header-table3"]),"hide-pagination":!0,"rows-per-page-options":[50]},{"no-data":s(({})=>[t("div",aa,[la,o(le,{size:"2em",name:"playlist_add"})])]),"body-cell-cantidad":s(a=>[o(V,{props:a,class:"flex flex-center"},{default:s(()=>[o($,{"input-class":"resaltarTextoInput",dense:"",required:"",onChange:n=>i(T)(a.row,"ventas"),min:"0",type:"number",style:{width:"80px"},modelValue:a.row.cantidad,"onUpdate:modelValue":n=>a.row.cantidad=n,modelModifiers:{trim:!0}},null,8,["onChange","modelValue","onUpdate:modelValue"])]),_:2},1032,["props"])]),"body-cell-descuento":s(a=>[o(V,{props:a,class:"flex flex-center"},{default:s(()=>[o($,{"input-class":"resaltarTextoInput",dense:"",required:"",onChange:n=>i(T)(a.row,"ventas"),min:"0",type:"number",style:{width:"100px"},modelValue:a.row.descuento,"onUpdate:modelValue":n=>a.row.descuento=n},null,8,["onChange","modelValue","onUpdate:modelValue"])]),_:2},1032,["props"])]),"body-cell-iva":s(a=>[o(V,{props:a},{default:s(()=>[g(m(a.row.aplicaIva?"SI":"NO"),1)]),_:2},1032,["props"])]),"body-cell-pvp":s(a=>[o(V,{props:a,class:"flex flex-center"},{default:s(()=>[o($,{"input-class":"resaltarTextoInput",dense:"",required:"",onChange:n=>i(T)(a.row,"ventas"),min:"0",type:"number",style:{width:"100px"},modelValue:a.row.pvp,"onUpdate:modelValue":n=>a.row.pvp=n},null,8,["onChange","modelValue","onUpdate:modelValue"])]),_:2},1032,["props"])]),"body-cell-acciones":s(a=>[o(V,{props:a},{default:s(()=>[o(z,{round:"",color:"deep-orange",onClick:n=>i(re)(a.row.id),icon:"close",size:"8px"},null,8,["onClick"])]),_:2},1032,["props"])]),_:1},8,["rows","columns","class"])]),o(ee,{class:"q-mt-md"},{default:s(()=>[o(ae,{class:"q-pt-none row"},{default:s(()=>[t("div",{class:d(["col-xs-12 col-sm-8 col-md-7 row items-center q-mt-md",l.$q.screen.width<=1023?"q-mt-lg q-mb-sm":""])},[t("div",ta,[t("div",{class:d(["col-xs-12 col-sm-5 col-md-3 flex flex-center",l.$q.screen.xs?"text-center":"text-right"])},oa,2),t("div",ra,[o($,{modelValue:r.value.descripcion,"onUpdate:modelValue":e[9]||(e[9]=a=>r.value.descripcion=a),filled:"",type:"textarea",rows:"4"},null,8,["modelValue"])])]),t("div",ia,[o($e,{"left-label":"",size:"xl",modelValue:F.value,"onUpdate:modelValue":e[10]||(e[10]=a=>F.value=a),label:"Enviar mensaje al cliente",color:"deep-orange-9","checked-icon":"task_alt","unchecked-icon":"highlight_off"},null,8,["modelValue"])])],2),t("div",na,[t("table",{class:d([l.$q.screen.xs?"":"linearTablaDetalle"])},[t("tr",da,[ua,t("td",ca," $"+m(i(_).subtotal.toFixed(2)),1)]),t("tr",ma,[pa,t("td",va," $"+m(i(_).descuento.toFixed(2)),1)]),t("tr",fa,[ga,t("td",_a," $"+m(i(E)(i(_).subtotal-i(_).descuento).toFixed(2)),1)]),t("tr",ba,[t("td",null,[t("b",null,"IVA("+m(i(J))+"%):",1)]),t("td",ha," $"+m(i(_).iva.toFixed(2)),1)]),t("tr",xa,[qa,t("td",ya,[o(De,{outline:"",class:"text-subtitle1 text-weight-bold",color:"secondary",label:`$${i(_).total.toFixed(2)}`},null,8,["label"])])])],2)]),t("div",{class:d(["col-12 flex q-mt-md q-my-lg",[l.$q.screen.width<600?"justify-center":"justify-between"]])},[l.$q.screen.width>600?(f(),x(z,{key:0,icon:"arrow_back",onClick:e[11]||(e[11]=a=>l.$router.push("/ventas")),outline:"",rounded:"",class:"q-mr-lg",color:l.$q.dark.isActive?"blue-grey-2":"blue-grey-10"},{default:s(()=>[g(" \xA0 Regresar ")]),_:1},8,["color"])):j("",!0),l.$route.params.proforma_id==""?(f(),x(z,{key:1,onClick:e[12]||(e[12]=a=>S("PROFORMA")),outline:"",rounded:"",class:"q-mr-lg",style:{color:"#696cff"}},{default:s(()=>[g(" \xA0 GENERAR PROFORMA ")]),_:1})):(f(),x(Ee,{key:2,outline:"",rounded:"",style:{color:"#696cff"},label:"Generar",class:d(l.$q.screen.width>=1023?"q-px-xl":"full-width")},{default:s(()=>[o(Ne,null,{default:s(()=>[te((f(),x(w,{clickable:"",onClick:e[13]||(e[13]=a=>S("EMISION"))},{default:s(()=>[o(A,null,{default:s(()=>[o(G,null,{default:s(()=>[g("Emitir Factura")]),_:1})]),_:1})]),_:1})),[[se]]),te((f(),x(w,{clickable:"",onClick:e[14]||(e[14]=a=>S("PROFORMA"))},{default:s(()=>[o(A,null,{default:s(()=>[o(G,null,{default:s(()=>[g("Guardar Cambios")]),_:1})]),_:1})]),_:1})),[[se]])]),_:1})]),_:1},8,["class"]))],2)]),_:1})]),_:1})])]),_:1}),o(we,{modelValue:i(C),"onUpdate:modelValue":e[16]||(e[16]=a=>L(C)?C.value=a:null)},{default:s(()=>[o(Fe,{listProductos:i(oe),onAgregarProduct:ve},null,8,["listProductos"])]),_:1},8,["modelValue"])],64))}};export{ja as default};
